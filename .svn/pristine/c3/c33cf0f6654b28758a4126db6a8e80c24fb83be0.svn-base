<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.system.mapper.service.ServicePackConditionMapper" >
      
     <!-- 新增 -->
	<insert id="insert" parameterType="org.system.entity.service.ServicePackCondition"  useGeneratedKeys="true" keyColumn="id">
	     insert into service_pack_condition (package_source_id,service_pack_id,address_id,enable_start_time,enable_end_time,price) 
	     values (#{packageSourceId},#{servicePackId},#{addressId},#{enableStartTime},#{enableEndTime},0)		 
	</insert>
	
	<!--  删除-->
	<delete id="delete" parameterType="org.system.entity.service.ServicePackCondition" >
	     	delete from service_pack_condition where id=#{id}
	</delete>

	<!-- 修改 -->
	<update id="update" parameterType="org.system.entity.service.ServicePackCondition">
		update service_pack_condition set id=#{id}

		<if test="packageSourceId !=null">

			,package_source_id=#{packageSourceId}
		</if>
		<if test="price !=null ">
			,price=#{price}
		</if>
		<if test="servicePackId !=null ">
			,service_pack_id=#{servicePackId}
		</if>

		<if test="addressId!=null">
			,address_id=#{addressId}
		</if>
		<if test="enableStartTime!=null">

			,enable_start_time=date(#{enableStartTime,jdbcType=TIMESTAMP})
		</if>
		<if test="enableEndTime!=null">
			,enable_end_time=date(#{enableEndTime,jdbcType=TIMESTAMP})
		</if>
		where id=#{id}
	</update>
	
	
	<!-- 根据主键查询单个 -->
	<select id="queryOne" parameterType="org.system.entity.service.ServicePackCondition" resultType="map">
		select spc.id ,sum(ps.times*ps.price) sprice,rs.id
		rsName,enable_start_time enableStartTime,enable_end_time
		enableEndTime,sp.id spName,spc.address_id addressId
		from service_pack_condition spc
		left join register_source rs on rs.id=spc.package_source_id
		left join service_pack sp on sp.id=spc.service_pack_id
		left join package_service ps on ps.service_pack_condition_id=spc.id
		where spc.id=#{id} order by spc.id  	
	</select>
	
	<!-- 根据约束键查询数据是否存在 -->
	<select id="checkExists" parameterType="org.system.entity.service.ServicePackCondition" resultType="map">
	    select package_source_id,service_pack_id,address_id,price from service_pack_condition where 
	    package_source_id =#{packageSourceId} and service_pack_id =#{servicePackId} and address_id=#{addressId}
	</select>


	<!-- 查询所有 -->
	<select id="queryAll" parameterType="org.system.entity.service.ServicePackCondition"
		resultType="map">
		select spc.id ,ps.times,ps.price ,sum((ps.times*ps.price)) sprice
		,rs.name rsName,sp.name spName,enable_end_time
		enableEndTime,enable_start_time enableStartTime, a.name
		code_nameSheQu,pt.id ptId,pt.name ptName
		from service_pack_condition spc left join register_source rs on
		rs.id=spc.package_source_id
		left join service_pack sp on sp.id=spc.service_pack_id
		left join address a on a.id =spc.address_id
		left join package_service ps on ps.service_pack_condition_id=spc.id
		left join package_type pt on pt.id =sp.package_type_id
		<where>
			<if test="packageSourceId!=null">
				package_source_id = #{packageSourceId}
			</if>
			<if test="servicePackId!=null">
				and service_pack_id = #{servicePackId}
			</if>
			<!-- <if test="addressId!=null "> and address_id = #{addressId} </if> -->
			<if test="addressCode!=null and addressCode!='' ">
				address_id= (select id from address where code_value=#{addressCode})
			</if>
		</where>
		group by spc.id
	</select>
	
	<!-- 根据地址的code_value查询地址的id号  -->
	 <select id="queryCodeId" resultType="int"   parameterType="org.system.entity.service.ServicePackCondition">
	   select id from address where code_value=#{addressCode}
	</select>

   <!--查询该优惠包是否被用户购买  -->
	<select id="queryConditionByBuy" resultType="int"   parameterType="org.system.entity.service.ServicePackCondition">
		select count(tbs.user_id) from 
               (select user_id from service_pack_condition spc left join user_service_pack us on spc.id=us.service_pack_id
                 where spc.id=#{id} limit 1) tbs
	</select>

</mapper>