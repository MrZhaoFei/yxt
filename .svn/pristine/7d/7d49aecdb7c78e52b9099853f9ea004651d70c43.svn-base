<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.system.mapper.hospital.HospitalMapper" >

     <!-- 新增 -->
	<insert id="insert" parameterType="org.system.entity.Hospital">
		insert into hospital (name,code_value,longitude,latitude,state,type,address,telephone,website,picture,remark,address_id,contract_num_prefix,contract_doc_id) 
		values (#{name},#{codeValue},#{longitude},#{latitude},#{state},#{type},#{address},#{telephone},#{website},#{picture},#{remark},#{addressId},#{contractNumPrefix},#{contractDocId})
	</insert>

    <!-- 删除 -->
	<delete id="delete" parameterType="org.system.entity.Hospital">
		DELETE FROM hospital WHERE id=#{id}
	</delete>
	
	<!-- 修改 -->
	<update id="update" parameterType="org.system.entity.Hospital"> 
		UPDATE hospital SET id=#{id}
			<if test="name !=null and name !=''">
			,name=#{name}
			</if>
			
			<if test="state !=null">
			,state=#{state}
			</if>
			
			<if test="type !=null">
			,type=#{type}
			</if>
			
			<if test="address !=null and address !=''">
			,address=#{address}
			</if>
			
			<if test="website !=null and website !=''">
			,website=#{website}
			</if>
			
			<if test="remark !=null and remark !=''">
			,remark=#{remark}
			</if>
			
			<if test="addressId !=null ">
			,address_id=#{addressId}
			</if>
			
			<if test="picture !=null and picture !=''">
			,picture=#{picture}
			</if>
			,contract_num_prefix=#{contractNumPrefix}			
			,contract_doc_id=#{contractDocId}
			<if test="telephone !=null and telephone !=''">
			,telephone=#{telephone}
			</if>
			
			<if test="codeValue!=null and codeValue!=''">
	       , code_value=#{codeValue}
	       </if>
		 WHERE id=#{id}
	</update>
	
	<!-- 查询 -->
	<select id="queryAll" parameterType="org.system.entity.Hospital" resultType="map">
		SELECT h.id,h.name hospName,h.code_value , h.address_id addressId,h.longitude,h.latitude,h.state,h.type,h.address,h.telephone,h.website,h.picture,h.remark,h.contract_num_prefix contractNumPrefix,h.contract_doc_id contractDocId,
       ct.doc_title docTitle FROM hospital h
       left join doc_tmplate ct on h.contract_doc_id=ct.id
			<where>
				<if test="addressCode!=null and addressCode!='' ">				
				address_id= (select id from address where code_value=#{addressCode}) 
			</if>
			 <if test="name!=null and name!=''">
		        and  h.name like CONCAT(CONCAT('%', #{name}), '%')
			</if>
			<if test="state!=null and state!=''">
			and	h.state =#{state}
			</if>
			<if test="type!=null ">
			and	h.type =#{type}
			</if> 
			</where>
	</select>
	
	
	<!-- 根据主键查询单个 -->
	<select id="queryOne" parameterType="org.system.entity.Hospital" resultType="map">
			 	SELECT h.id,h.name hospName,h.code_value,h.address_id addressId,h.longitude,h.latitude,h.state,h.type ,h.address,h.telephone,h.website,h.picture,h.remark,h.contract_num_prefix contractNumPrefix,h.contract_doc_id contractDocId,
			 	ct.id docTitle FROM hospital h
	           left join doc_tmplate ct on h.contract_doc_id=ct.id  WHERE h.id=#{id}
	</select>


<!-- 检查唯一性 -->
    <select id="checkExists" parameterType="org.system.entity.Hospital" resultType="map">
	    SELECT id,name,code_value,longitude,latitude,state,type,address,telephone,website,picture,remark FROM hospital 
	    <where>
	       <if test="name!=null and name!=''">
	         name=#{name}
	       </if>
	       <if test="codeValue!=null and codeValue!=''">
	        and code_value=#{codeValue}
	       </if>
	       <if test="state!=null and state!=''">
	        and state=#{state}
	       </if>
	       <if test="type!=null">
	         and type=#{type} 
	       </if>
	       <if test="address!=null and address!=''">
	        and address=#{address}
	       </if>
	        <if test="telephone!=null and telephone!=''">
	         and telephone=#{telephone}
	        </if>
	        <if test="website!=null and website!=''">
	          and website=#{website}
	        </if>
	        <if test="picture!=null and picture!=''">
	         and picture=#{picture}
	         </if>
	         <if test="remark!=null and remark!=''">
	          and remark=#{remark}
	          </if>
	          <if test="addressId !=null ">
			and address_id=#{addressId}
			</if>	               
	    </where>  
     </select>
     
     
     <!--根据行政区域的code_value的查询出行政区域的id值  -->
    <select id="queryCodeId" resultType="int"   parameterType="org.system.entity.Hospital">
   select id from address where code_value=#{addressCode}
</select>

 <!--查询机构中的 卫生服务中心 和医院类型  -->
  <select id="queryWeiAndYi" parameterType="org.system.entity.Hospital" resultType="map">
  select h.id,h.name hospName,h.code_value,h.address_id addressId,h.longitude,h.latitude,h.state,h.type,h.address,h.telephone,h.website,h.picture from hospital h where h.type in (1,2)
  </select>
  
 
	  <!--查询该机构是否被签约 -->
	  <select id="queryHospitalContract" parameterType="org.system.entity.Hospital"  resultType="int">
	   select count(tbs.num)  from  (select c.id num from hospital h left join doctor_group dg on dg.hospital_id=h.id left join contract c on c.doctor_group_id =dg.id where h.id=#{id} limit 1 ) tbs 
	  </select>
 
  <!-- 修改已签约的机构 -->
	<update id="updateHospitalContract" parameterType="org.system.entity.Hospital"> 
		UPDATE hospital SET id=#{id}

			<if test="state !=null">
			,state=#{state}
			</if>

			<if test="address !=null and address !=''">
			,address=#{address}
			</if>
			
			<if test="website !=null and website !=''">
			,website=#{website}
			</if>
			
			<if test="remark !=null and remark !=''">
			,remark=#{remark}
			</if>
			
			<if test="addressId !=null ">
			,address_id=#{addressId}
			</if>
			
			<if test="picture !=null and picture !=''">
			,picture=#{picture}
			</if>
			<if test="contractNumPrefix !=null and contractNumPrefix !=''">
			,contract_num_prefix=#{contractNumPrefix}			
			</if>
			<if test="contractDocId !=null and contractDocId !=''">
			,contract_doc_id=#{contractDocId}		
			</if>
			<if test="telephone !=null and telephone !=''">
			,telephone=#{telephone}
			</if>
			<if test="codeValue!=null and codeValue!=''">
	       , code_value=#{codeValue}
	       </if>
		 WHERE id=#{id}
	</update>
  
  
  
 <!-- 查询所有根据五级地址  根据地址的code_value -->
  <select id="queryAllHospitalList" resultType="map" parameterType="org.system.entity.Hospital">
    select h.id, h.code_value codeValue,fn_print_sys_code_result(h.code_value,';','CV02.01.101') codeValueName, h.`name`, 
    h.state, h.type, h.address, h.telephone, h.website, h.picture, h.address_id addressId, 
    h.longitude, h.latitude, h.contract_num_prefix contractNumPrefix, h.contract_doc_id contractDocId, h.remark
    from hospital h
    left join address a on a.id=h.address_id
   	<where>
   		<if test="addressId !=null ">
   			h.address_id=#{addressId}
   		</if>
   		<if test="type !=null ">
   			and h.type=#{type}
   		</if>
   		<if test="name !=null and name !=''">
   			and h.`name` like CONCAT(CONCAT('%', #{name}), '%')
   		</if>
   		<if test="addressList !=null">
	   			and a.code_value in 
   			<foreach collection="addressList" item="item" open="(" close=")" separator=",">
   				'${item}'
   			</foreach>
   		</if>
   	</where>
  </select> 
  

</mapper>