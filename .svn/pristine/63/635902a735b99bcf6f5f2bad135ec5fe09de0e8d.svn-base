<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.system.mapper.sms.SmsSendTaskMapper" >

	<!-- 查询列表 -->
	<select id="queryAll" parameterType="org.system.entity.sms.SmsSendTask" resultType="map">
		select sst.id,sst.`from`,sst.from_doctor_id doctorId,sst.`to`,sms_type smsType,
		sst.to_user_id userId,sst.content,sst.start_send_time startSendTime from sms_send_task sst 
		<where>
			<if test="toUserId!=null">
			    sst.to_user_id=#{toUserId}
			</if>
			<if test="fromDoctorId !=null">
			    and sst.from_doctor_id =#{fromDoctorId}
			</if>
			<choose>
				<when test="startSendTime!=null  and endSendTime!=null">
						and sst.start_send_time between #{startSendTime} and #{endSendTime} 
				</when>
				<otherwise>
					<if test="startSendTime !=null">
						and sst.start_send_time &gt; #{startSendTime}
					</if>
					<if test="endSendTime !=null">
						and sst.start_send_time &lt; #{endSendTime}
					</if>
				</otherwise>
			</choose>
			<if test="smsType!=null">
				and sst.sms_type=#{smsType} 
			</if>
		</where>
	</select>
	
	<!-- 历史记录 -->
	<select id="getSmsSendHistoryList" parameterType="org.system.entity.sms.SmsSendTask" resultType="map">
		select ssthi.id,ssthi.`from`,ssthi.from_doctor_id doctorId,ssthi.`to`,ssthi.to_user_id userId,ssthi.content,ssthi.send_time sendTime,dd.`name` doctorName,ud.`name` userName
		from sms_send_task_history_info ssthi
		left join doctor_detail dd on dd.doctor_id=ssthi.from_doctor_id
		left join user_detail ud on ud.user_id=ssthi.to_user_id
		<where>
			<if test="toUserId!=null">
			    ssthi.to_user_id=#{toUserId}
			</if>
			<if test="fromDoctorId !=null">
			    and ssthi.from_doctor_id =#{fromDoctorId}
			</if>
			<if test="content !=null and content !=''">
			    and ssthi.content =#{content}
			</if>
			<choose>
				<when test="startSendTime!=null  and endSendTime!=null">
						and sst.start_send_time between #{startSendTime} and #{endSendTime} 
				</when>
				<otherwise>
					<if test="startSendTime !=null">
						and sst.start_send_time &gt; #{startSendTime}
					</if>
					<if test="endSendTime !=null">
						and sst.start_send_time &lt; #{endSendTime}
					</if>
				</otherwise>
			</choose>
			<if test="smsType!=null">
				and ssthi.sms_type=#{smsType} 
			</if>
		</where>
	</select>

	<!-- 新增 -->
    <insert id="insert" parameterType="org.system.entity.sms.SmsSendTask" >
   	 	insert into sms_send_task(`from`, from_doctor_id, `to`, to_user_id, content,  start_send_time,create_time,sms_type)
   		values(#{from},#{fromDoctorId},#{to}, #{toUserId}, #{content}, #{startSendTime},#{createTime},#{smsType})
    </insert>
    <insert id="insertByMap" parameterType="map" >
   	 	insert into sms_send_task(`from`, from_doctor_id, `to`, to_user_id, content,  start_send_time,create_time,sms_type)
   		values
   		<foreach collection="users"  separator="," item="user">
   			(#{from},#{fromDoctorId},#{user.phone}, #{user.id}, #{content}, #{sendTime},#{createTime},#{smsType})
		</foreach>
    </insert>
  
  <!-- 修改 -->
  	<update id="update" parameterType="org.system.entity.sms.SmsSendTask">
		update sms_send_task set id=#{id}
		<if test="content !=null">
			,content=#{content}
		</if>
		<if test="startSendTime !=null ">
			,start_send_time=#{startSendTime}
		</if>
		where id=#{id}
	</update>
  
  	<!-- 删除 -->
	<delete id="delete" parameterType="org.system.entity.sms.SmsSendTask">
		delete from sms_send_task where id=#{id} 
	</delete>
  	<!-- 删除 -->
	<delete id="deleteByMap" parameterType="map">
			delete from sms_send_task where 
		<foreach collection="hintList" item="hint" separator="or">
			(from_doctor_id=#{fromDoctorId} and to_user_id=#{hint.userId} and start_send_time=#{smsSendTime} and sms_type=#{smsType}) 
		</foreach>
	</delete>
</mapper>