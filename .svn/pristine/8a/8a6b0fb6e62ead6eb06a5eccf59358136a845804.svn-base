<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.system.mapper.doctor.DoctorMapper">
<!-- 查询权限 -->
<select id="getPermission" parameterType="map" resultType="map">
	select o.resource from user_role ur
	left join user u on u.id=ur.user_id
	right join role r on r.id=ur.role_id
	left join role_permission rp on
	rp.role_id=r.id
	left join permission p on p.id=rp.permission_id
	left
	join permission_operation op on op.permission_id=p.id
	left join
	operation o on o.id=op.operation_id where r.id=1
	<if test="id!=null and id!=''">
		or ur.user_id=#{id}
	</if>
</select>
<!-- 查询单个用户 -->
<select id="queryOne" parameterType="org.system.entity.doctor.Doctor" resultType="map">
select d.id,dd.`name`,d.`name` account,d.phone,d.wechat_id wechatID,d.state,d.register_date registerDate,d.is_valid isValid,
			rs.name registerSourceName,dt.name typeName,t.name titleName,d.doctor_level_id doctorLevelId,
			dt.oder_level doctorTypeOrderLevel,dl.doctor_level_name doctorLevelName,dl.order_level doctorLevelOrderLevel,
			d.doctor_type_id doctorTypeId,h.`name` hospitalName,dpt.`name` departmentName,d.zw_name zwName,d.itv_number itvNumber,
			d.zxz_number zxzNumber,d.ID_Card IDCard,dd.birthday,dd.photo,dd.school,dd.`profile`,dd.grade,dd.gootat,dd.address_detail addressDetail,
			dd.zp_hospital_id zpHospitalId,dd.zp_department_id zpDepartmentId,h.address hospitalAddress	
			from doctor d 
			left join register_source rs on rs.id=d.register_source_id
			left join doctor_type dt on dt.id=d.doctor_type_id
			left join title t on t.id=d.title_id
		 	left join doctor_detail dd on dd.doctor_id=d.id
			left join doctor_level dl on dl.id=d.doctor_level_id
			LEFT JOIN hospital h on h.id=dd.zp_hospital_id
			LEFT JOIN department dpt on dpt.id=dd.zp_department_id
	where d.name=#{name} and d.password=#{password}
</select>
<!-- 修改密码 -->
<update id="updateById" parameterType="org.system.entity.doctor.Doctor">
	update doctor
	<set>
		<if test="password !=null and password!=''">
			password=#{password},
		</if>
		<if test="phone !=null and phone!=''">
			phone=#{phone},
		</if>
	</set>
	where id=#{id}
</update>
<!-- 修改密码 -->
<update id="updateByName" parameterType="org.system.entity.doctor.Doctor">
	update doctor
	<set>
		<if test="password !=null and password!=''">
			password=#{password},
		</if>
	</set>
	where name=#{name}
</update>
<!-- 根据phone 修改 wechat_id、union_id  -->
<update id="updateByPhone" parameterType="org.system.entity.doctor.Doctor">
	update doctor
	<set>
		<if test="wechatId !=null and wechatId !=''">
			wechat_id=#{wechatId},
		</if>
		<if test="unionId !=null and unionId !=''">
			union_id=#{unionId},
		</if>
	</set>
	where phone=#{phone}
</update>
<!-- 查询详情 -->
<select id="getDoctorDetil" parameterType="org.system.entity.doctor.Doctor" resultType="map">
	select d.id,dd.name from doctor d
	left join doctor_detail dd on dd.doctor_id=d.id
	 where d.id=#{id}
	<if test="oldPassword!=null and oldPassword!=''">
		and d.password=#{oldPassword}
	</if>
</select>
<!-- 查询详情 -->
<select id="getDoctorByFiled" parameterType="org.system.entity.doctor.Doctor" resultType="map">
	select id,phone from doctor
	<where>
		<if test="name!=null and name!=''">
			 name=#{name}
		</if>
		<if test="phone !=null and phone !=''">
			 and phone=#{phone}
		</if>
	</where>
</select>

<!-- 查询医生列表 -->
<select id="queryAll" parameterType="org.system.entity.doctor.Doctor" resultType="map">
select h.id hospitalId,h.`name` hospitalName,d.id doctorId,dd.`name` doctorName,dm.id departmentId,dm.`name` departmentName,
	   t.id titleId,t.`name` titleName,dt.id doctorTypeId,dt.`name` doctorTypeName,dl.id doctorLevelId,dl.doctor_level_name doctorLevelName
	from hospi_depart_doctor_relation hddr
	left join hospital h on h.id=hddr.hospital_id
	left join doctor d on d.id=hddr.doctor_id
	left join doctor_detail dd on dd.doctor_id=d.id
	left join title t on t.id=d.title_id
	left join doctor_type dt on dt.id=d.doctor_type_id
	left join doctor_level dl on dl.id=d.doctor_level_id
	left join department dm on dm.id=hddr.department_id
	<where>
		<if test="id !=null">
			 d.id!=#{id}
		</if>
		<if test="hospitalId !=null">
			and h.id=#{hospitalId}
		</if>
		<if test="departmentId !=null">
			and dm.id=#{departmentId}
		</if>
		<if test="titleId !=null">
			and t.id=#{titleId}
		</if>
		<if test="doctorTypeId !=null">
			and d.doctor_type_id=#{doctorTypeId}
		</if>
		<if test="userServiceId !=null">
			 and d.doctor_level_id=(select ps.doctor_level_id from user_service us left join product_service ps on ps.id=us.product_service_id where us.id=#{userServiceId})
			 and d.doctor_type_id=(select ps.doctor_type_id from user_service us left join product_service ps on ps.id=us.product_service_id where us.id=#{userServiceId})
		</if>
	</where>
</select>
<!-- 查询医生的患者列表 -->
<select id="getDoctorPatientsList" parameterType="org.system.entity.doctor.Doctor" resultType="map">
	select ud.user_id userId,ud.`name` userName,(DATE_FORMAT(FROM_DAYS(TO_DAYS(NOW())-TO_DAYS(ud.birthday)), '%Y')+0) age,ud.id_card idcard,ud.sex,ud.contact,ud.home_address homeAddress,u.phone,
	c.contract_number contractNumber,dd.`name` doctorName,c.create_date createDate
	from v_get_my_patients vgmp
	left join user_detail ud on ud.user_id=vgmp.user_id
	left join user u on u.id=ud.user_id
	left join contract c on c.user_id=vgmp.user_id
	left join doctor_detail dd on dd.doctor_id=c.creator_id
	where vgmp.doctor_id=#{id}
	<if test="userDetail !=null">
		<if test="userDetail.sex !=null">
			and ud.sex=#{userDetail.sex}
		</if>
		<if test="userDetail.name !=null and userDetail.name !=''">
			and ud.`name` like CONCAT(CONCAT('%', #{userDetail.name}), '%')
		</if>
		<if test="userDetail.idcard !=null and userDetail.idcard !=''">
			and ud.id_card like CONCAT(CONCAT('%', #{userDetail.idcard}), '%')
		</if>
		<choose>
			<when test="userDetail.age !=null and userDetail.endAge !=null">
				and ud.birthday between DATE_FORMAT(DATE_SUB(NOW(),INTERVAL #{userDetail.endAge} YEAR),'%Y-1-1') and DATE_FORMAT(DATE_SUB(NOW(),INTERVAL #{userDetail.age} YEAR),'%Y-12-31')
				<!-- and ud.age between #{userDetail.age} and #{userDetail.endAge} -->
			</when>
			<otherwise>
				<if test="userDetail.age !=null">
					and ud.birthday &lt;= DATE_FORMAT(DATE_SUB(NOW(),INTERVAL #{userDetail.age} YEAR),'%Y-12-31')
					<!-- and ud.age &gt;= #{userDetail.age} -->
				</if>
				<if test="userDetail.endAge !=null">
					and ud.birthday &gt;= DATE_FORMAT(DATE_SUB(NOW(),INTERVAL #{userDetail.endAge} YEAR),'%Y-1-1')
					<!-- and ud.age &lt;= #{userDetail.endAge} -->
				</if>
			</otherwise>
		</choose>
	</if>
	<if test="user !=null">
		<if test="user.phone !=null">
			and u.phone like CONCAT(CONCAT('%', #{user.phone}), '%')
		</if>
	</if>
   <choose>
		<when test="startDate!=null and endDate!=null">
			and c.create_date between #{startDate} and #{endDate}
		</when>
		<otherwise>
			<if test="startDate!=null">
				and c.create_date &gt; #{startDate}
			</if>
			<if test="endDate!=null">
				and c.create_date &lt; #{endDate}
			</if>
		</otherwise>
	</choose>
	
	
</select>
</mapper>