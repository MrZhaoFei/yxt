<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.system.mapper.service.transfer.TransTreatDetailyMapper" >
<!-- 新增 -->
	<insert id="insert" parameterType="org.system.entity.service.transfer.TransTreatDetaily" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO `trans_treat_detaily` (`yuyue_count_info_id`,`trans_treat_number`,`snapshot`,`trans_date`, `from_doctor_id`,`doctor_id`, `service_resp_task_id`,`used_count`, `used_date`, `user_service_id`, `sick_time`, `first_diagnosis_desc`, `jws_desc`, `zljg_desc`, `trans_reason`,`status`,hm_zdjg,hm_zljg,hm_kfjy,hm_gjtysjy) 
		VALUES (#{yuyueCountInfoId},#{transTreatNumber}, #{snapshot},#{transDate},#{fromDoctorId}, #{doctorId}, #{serviceRespTaskId},#{usedCount}, #{usedDate}, #{userServiceId}, #{sickTime}, #{firstDiagnosisDesc}, #{jwsDesc}, #{zljgDesc}, #{transReason},#{status},#{hmZdjg},#{hmZljg},#{hmKfjy},#{hmGjtysjy})
	</insert>
	<insert id="insertTransTreatDetailyFiles" parameterType="org.system.entity.service.transfer.TransTreatDetaily">
		INSERT INTO `medical_record_doc_info` (`doc_url`, `trans_treat_detaily_id`,`doc_type`) 
		VALUES 
		<foreach collection="files" item="item" separator=",">
			(#{item.file}, #{id},#{item.type})
		</foreach>
	</insert>
	
	<!-- 修改 -->
	<update id="update" parameterType="org.system.entity.service.transfer.TransTreatDetaily">
		update trans_treat_detaily set id=#{id}
		<if test="doctorId!=null">
			,doctor_id=#{doctorId}
		</if>
		<if test="sickTime!=null">
			,sick_time=#{sickTime}
		</if>
		<if test="fromDoctorId !=null">
			,from_doctor_id=#{fromDoctorId}
		</if>
		<if test="status !=null">
			,status=#{status}
		</if>
		<if test="firstDiagnosisDesc !=null and firstDiagnosisDesc !=''">
			,first_diagnosis_desc=#{firstDiagnosisDesc}
		</if>
		<if test="jwsDesc !=null and jwsDesc !=''">
			,jws_desc=#{jwsDesc}
		</if>
		<if test="zljgDesc !=null and zljgDesc !=''">
			,zljg_desc=#{zljgDesc}
		</if>
		<if test="transReason !=null and transReason !=''">
			,trans_reason=#{transReason}
		</if>
		<if test="hmZdjg !=null and hmZdjg !=''">
			,hm_zdjg=#{hmZdjg}
		</if>
		<if test="hmZljg !=null and hmZljg !=''">
			,hm_zljg=#{hmZljg}
		</if>
		<if test="hmKfjy !=null and hmKfjy !=''">
			,hm_kfjy=#{hmKfjy}
		</if>
		<if test="hmGjtysjy !=null and hmGjtysjy !=''">
			,hm_gjtysjy=#{hmGjtysjy}
		</if>
		where id=#{id}
	</update>
	<!-- 查询列表 -->
	<select id="queryAll" parameterType="org.system.entity.service.transfer.TransTreatDetaily" resultType="map">
	select ttd.id,ttd.user_service_id userServiceId,ttd.service_resp_task_id taskId,ttd.doctor_id doctorId,srt.user_id userId,
	srt.task_number taskNumber,ttd.trans_treat_number transTreatNumber,ud.`name` userName,u.phone,dd.`name` doctorName,srt.applied_date appliedDate,
	ttd.trans_date transDate,ps.`name` serviceName,st.`name` serviceTypeName,yci.yuyue_date yuyueDate,ttd.snapshot,ps.service_type_id serviceTypeId,
	ttd.`status`,fdd.`name` fromDoctorName,d.doctor_level_id doctorLevelId,dl.doctor_level_name doctorLevelName
	from trans_treat_detaily ttd
	left join yuyue_count_info yci on yci.id=ttd.yuyue_count_info_id
	left join user_service us on us.id=ttd.user_service_id
	left join product_service ps on ps.id=us.product_service_id
	left join service_type st on st.id=ps.service_type_id
	left join service_resp_task srt on srt.id=ttd.service_resp_task_id
	left join user_detail ud on ud.user_id=srt.user_id
	left join user u on u.id=ud.user_id
	left join doctor d on d.id=ttd.doctor_id
	left join doctor fd on fd.id=ttd.from_doctor_id
	left join doctor_level dl on d.doctor_level_id=dl.id
	left join doctor_detail dd on dd.doctor_id=ttd.doctor_id
  left join doctor_detail fdd on fdd.doctor_id=ttd.from_doctor_id
  where  ttd.status not in (2,4,7)
		<if test="serviceRespTaskId !=null">
			and service_resp_task_id=#{serviceRespTaskId}
		</if>
		<if test="serviceRespTask !=null">
			<if test="serviceRespTask.taskNumber !=null and serviceRespTask.taskNumber !=''">
					and srt.task_number like CONCAT(CONCAT('%', #{serviceRespTask.taskNumber}), '%')
			</if>
			<choose>
				<when test="serviceRespTask.startDate !=null and serviceRespTask.endDate !=null">
					and srt.applied_date BETWEEN #{serviceRespTask.startDate} and #{serviceRespTask.endDate}
				</when>
				<otherwise>
					<if test="serviceRespTask.startDate !=null">
						and srt.applied_date &gt; #{serviceRespTask.startDate}
					</if>
					<if test="serviceRespTask.endDate !=null">
						and srt.applied_date &lt; #{serviceRespTask.endDate}
					</if>
				</otherwise>
			</choose>
		</if>
		<if test="serviceType !=null">
			<if test="serviceType.id !=null">
				and st.id=#{serviceType.id}
			</if>
		</if>
		<choose>
				<when test="startDate !=null and endDate !=null">
					and ttd.trans_date BETWEEN #{startDate} and #{endDate}
				</when>
				<otherwise>
					<if test="startDate!=null">
						and ttd.trans_date &gt; #{startDate}
					</if>
					<if test="endDate!=null">
						and ttd.trans_date &lt; #{endDate}
					</if>
				</otherwise>
		</choose>
		<if test="status !=null">
			and ttd.status=#{status}
		</if>
		<if test="transTreatNumber !=null and transTreatNumber !=''">
				and ttd.trans_treat_number like CONCAT(CONCAT('%', #{transTreatNumber}), '%')
		</if>
		<if test="doctor !=null">
			<if test="doctor.name !=null and doctor.name !=''">
				and	d.name like CONCAT(CONCAT('%', #{doctor.name}), '%')
			</if>
		</if>
		
		<if test="doctorName !=null and doctorName !=''">
			and	dd.`name` like CONCAT(CONCAT('%', #{doctorName}), '%')
		</if>
		<if test="fromDoctorName !=null and fromDoctorName !=''">
			and	fdd.`name` like CONCAT(CONCAT('%', #{fromDoctorName}), '%')
		</if>
		
		<if test="doctorId !=null">
			and	ttd.doctor_id=#{doctorId}
			<!-- <choose>
				<when test="status!=null and status==1">
					and	ttd.from_doctor_id=#{doctorId}
				</when>
				<otherwise>
					and	ttd.doctor_id=#{doctorId}
				</otherwise>
			</choose> -->
		</if>
		<if test="user !=null">
			<if test="user.phone !=null and user.phone !=''">
				and	u.phone like CONCAT(CONCAT('%', #{user.phone}), '%')
			</if>
		</if>
		<if test="userDetail !=null">
			<if test="userDetail.name !=null and userDetail.name !=''">
				and	ud.name like CONCAT(CONCAT('%', #{userDetail.name}), '%')
			</if>
		</if>
	order by transDate desc
	</select>
	<resultMap type="map" id="transMap">
		<result column="id" property="id"/>
		<collection property="files" column="id" javaType="list" select="getFiles"/>
	</resultMap>
	<!-- 根据主键查询单个 -->
	<select id="queryOne" parameterType="org.system.entity.service.transfer.TransTreatDetaily" resultMap="transMap">
	select ttd.id,ttd.user_service_id userServiceId,ttd.service_resp_task_id taskId,ttd.doctor_id doctorId,srt.user_id userId,ps.id productServiceId,ps.`name` serviceName,
	srt.task_number taskNumber,ud.`name` userName,ud.contact,dd.`name` doctorName,srt.applied_date appliedDate,ttd.trans_date transDate,ps.common_field commonField,yci.yuyue_date yuyueDate,
	ttd.`status`,fdd.`name` fromDoctorName,ttd.first_diagnosis_desc firstDiagnosisDesc,ttd.jws_desc jwsDesc,ttd.sick_time sickTime,ttd.trans_reason transReason,ttd.snapshot,u.wechat_id wechatId,
	ttd.zljg_desc zljgDesc,ttd.trans_treat_number transTreatNumber,ttd.used_count usedCount,ttd.used_date usedDate,us.times times,us.lock_times lockTimes,ttd.from_doctor_id fromDoctorId,
	ttd.hm_zdjg hmZdjg,ttd.hm_zljg hmZljg,ttd.hm_kfjy hmKfjy,ttd.hm_gjtysjy hmGjtysjy,yci.yuyue_date yuyueDate,u.phone,dl.doctor_level_name doctorLevelName,dt.`name` doctorTypeName,ps.service_type_id serviceTypeId 
	from trans_treat_detaily ttd
	left join user_service us on us.id=ttd.user_service_id
	left join product_service ps on ps.id=us.product_service_id
	left join doctor_level dl on dl.id=ps.doctor_level_id
	left join doctor_type dt on dt.id=ps.doctor_type_id
	left join service_resp_task srt on srt.id=ttd.service_resp_task_id
	left join user_detail ud on ud.user_id=srt.user_id
	left join user u on u.id=ud.user_id
	left join doctor d on d.id=ttd.doctor_id
	left join doctor_detail dd on dd.doctor_id =d.id
	left join doctor fd on fd.id=ttd.from_doctor_id
	left join doctor_detail fdd on fdd.doctor_id=fd.id
	left join yuyue_count_info yci on ttd.yuyue_count_info_id=yci.id
	where ttd.id=#{id}
	</select>
	

	<!-- 后台医生查询用户服务响应的转诊记录列表 -->
	<select id="getTransTreatDetailyDoctorByUserList" parameterType="org.system.entity.service.transfer.TransTreatDetaily" resultType="map">
	select ttd.id,ttd.trans_treat_number transTreatNumber,ttd.trans_date transDate,ttd.from_doctor_id fromDoctorId,dd.name fromDoctorName,ttd.snapshot,
		ttd.doctor_id doctorId,ddl.name doctorName,ttd.service_resp_task_id serviceRespTaskId,ttd.used_count usedCount,ttd.used_date usedDate,
		ttd.user_service_id userServiceId,ttd.sick_time sickTime,ttd.first_diagnosis_desc firstDiagnosisDesc,ttd.jws_desc jwsDesc,ps.`name` serviceName,st.`name` serviceTypeName,
		ttd.zljg_desc zljgDesc,ttd.trans_reason transReason,ttd.status,srt.task_number taskNumber,
		srt.task_type_id taskTypeId,tt.task_name taskName,srt.applied_date appliedDate
		from trans_treat_detaily ttd
	left join user_service us on us.id=ttd.user_service_id
	left join product_service ps on ps.id=us.product_service_id
	left join service_type st on st.id=ps.service_type_id
	left join service_resp_task srt on srt.id=ttd.service_resp_task_id
	left join doctor_detail dda on dda.doctor_id=srt.doctor_id
	left join task_type tt on tt.id=srt.task_type_id
	left join doctor_detail dd on dd.doctor_id=ttd.from_doctor_id
	left join doctor_detail ddl on ddl.doctor_id=ttd.doctor_id
	left join doctor d on d.id=dd.doctor_id 
	left join doctor dh on dh.id=ddl.doctor_id 
	where ttd.service_resp_task_id=#{serviceRespTaskId}
	<if test="serviceType !=null">
		<if test="serviceType.id !=null">
			and st.id=#{serviceType.id}
		</if>
	</if>
	order by transDate desc
	</select>

	<select id="getFiles" parameterType="int" resultType="map">
		select id,doc_url docUrl,doc_type docType from medical_record_doc_info where trans_treat_detaily_id=#{id}
	</select>
</mapper>