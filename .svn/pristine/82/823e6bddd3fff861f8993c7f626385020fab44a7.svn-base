<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head> 
  <base href="/yxt-admin/" /> 
  <title>用户列表</title> 
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
  <meta HTTP-EQUIV="Cache-Control" CONTENT="no-cache"> 
  <meta HTTP-EQUIV="Expires" CONTENT="0">  
  <link rel="stylesheet" type="text/css" href="/yxt-admin/js/easyui/themes/icon.css" /> 
  <link rel="stylesheet" type="text/css" href="/yxt-admin/js/easyui/themes/gray/easyui.css" /> 
  <link rel="stylesheet" type="text/css" href="/yxt-admin/css/jquery.flex-images.css" /> 
  <link rel="stylesheet" type="text/css" href="/yxt-admin/css/icon/font-awesome.min.css" /> 
  <link rel="stylesheet" type="text/css" href="/yxt-admin/css/upload/webuploader.css" /> 
  <link rel="stylesheet" type="text/css" href="/yxt-admin/css/upload/style.css" /> 
  <link rel="stylesheet" type="text/css" href="/yxt-admin/css/web.css" /> 
  <script type="text/javascript" src="/yxt-admin/js/jquery.min.js"></script> 
  <script type="text/javascript" src="/yxt-admin/js/easyui/jquery.easyui.min.js"></script> 
  <script type="text/javascript" src="/yxt-admin/js/easyui/locale/easyui-lang-zh_CN.js"></script> 
  <script type="text/javascript" src="/yxt-admin/js/easyui/extend.easyui.js"></script> 
  <script type="text/javascript" src="/yxt-admin/js/jquery.flex-images.min.js"></script> 
  <script type="text/javascript">
  
  
  $(function() {
	
	  $('#main_table').datagrid({
	    method: 'get',
	    url: '/yxt-admin/admin/adminUser?ran=' + Math.random(),
	    toolbar: '#seach',
	    pagination: true,
	    pageSize:20,
	    fit: true,
	    fitColumns: true,
	    border: false,
	    rownumbers: true,
	    singleSelect: true,
	    loadFilter: function(data) {
	    	if(data.stateCode=='205'){
	    		top.location.href="/yxt-admin/adminLogin.html";
	    		return;
	    	}else if(data.stateCode=='203'){
	    		return {total:0,rows:[]};
	    	}
	      return data.data;
	    } 
	  });
	  
	  
	  
 	 
	});
  
  
  
  
	function query() {
	  $('#main_table').datagrid('load', {
	    username: $('#name').textbox('getValue'),
	    userType: $('#usertype').combobox('getValue')
	  });
	}
	

	function clear() {
	  $('#name').textbox('clear');
	  $('#usertype').combobox('clear');
	  $('#lookhosName').textbox('clear');		
		 $('#codeName').combobox('clear');
		 $('#code_nameShi').combobox('clear');
		 $('#code_nameQu').combobox('clear');
		 $('#code_namebut').combobox('clear');
		 $('#code_nameSheQu').combobox('clear');
	 
	}
	
	 function re(){
	   	  history.go(0) 
	 }
	
	
	function _sexformatter(value, row, index) {
	  if (value == 1) {
	    return "启用";
	  }if (value == 0){
	  return "停用";
		  
	  }
	}
	
	function _usertypeformatter(value, row, index) {
		  if (value == 1) {
		    return "管理员";
		  }if (value == 2){
		  return "协同人员";
		  }if (value == 3){
		  return "机构人员";
			  
		  }
		}
	
	
	
	function _opformatter(value, row, index) {
	  var a = '&nbsp;<a href="javascript:edit(\'' + row.username + '\',' + row.id + ')" title="修改密码"><i class="fa fa-pencil"></i></a>'; 
	  var c = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp<a href="javascript:del(\'' + row.id + '\')" title="删除"><i class="fa fa-trash"></i></a>'; 
	  return a+c;
	}
	
	
	
	
	function add() {
		$('.pwd').show();
		$('.hospital').hide(); 
	  $('#form').form('reset');
	  $('#password').textbox({'required': true}); 
	  $('#user_type').combobox({
		  onChange:function(newValue,oldValue){
			  if(newValue==3){
				 $('.hospital').show(); 
			  } else {
				 $('.hospital').hide(); 
			  }
		  }
	  })
 
	  $('#dialog').dialog({
	    title: '添加信息',
	    width: 500,
	    height: 350,
	    closed: false,
	    modal: true,
	    buttons: [{
	      text: '确定添加',
	      handler: function() {
	        var v = $('#form').form('validate');
	        if (v) {      	
	        	 $.ajax({
	                  type: 'POST',
	                  url: '/yxt-admin/admin/adminUser/insert',
	                 data:{
	                	username:$('#username').textbox('getValue'),
	                	password:$('#password').textbox('getValue'),
	                	state:$('#state').combobox('getValue'),	
	                	remark:$('#remark').textbox('getValue'),
	                	userType:$('#user_type').combobox('getValue'),
	                	hospitalId:$('#hospital_id').textbox('getValue')
	                },  
	                  success: function(data) {
	                    if (data.stateCode == 200) {
	                      $('#main_table').datagrid('reload');
	                      $('#dialog').dialog('close');
	                      $.messager.show({
	                        title: '提示消息',
	                        msg: data.message,
	                        timeout: 5000,
	                        showType: 'slide'
	                      });
	                    } else {
	                      $.messager.show({
	                        title: '提示',
	                        msg: data.message
	                      });
	                    }
	                  },
	                  error: function(XMLHttpRequest, textStatus, errorThrown) {
	                    $.messager.show({
	                      title: '提示',
	                      msg: '请求发生错误请联系开发者'
	                    });
	                  }
	                });
	               
	          }
	        }
	      },
	    {
	      text: '取消关闭',
	      handler: function() {
	        $('#dialog').dialog('close');
	      }
	    }]
	  });	
	
	}
	
	function del(id) {
		  $.messager.confirm('确认', '您确认想要删除记录吗？',
		  function(r) {
		    if (r) {
		      $.ajax({
		        type: 'delete',
		        url: '/yxt-admin/admin/adminUser/' + id + '/delete',
		        success: function(data) {
		          if (data.stateCode == 200) {
		            $('#main_table').datagrid('reload');
		            $.messager.show({
		              title: '提示消息',
		              msg: data.message,
		              timeout: 5000,
		              showType: 'slide'
		            });
		          } else {
		            $.messager.show({
		              title: '提示',
		              msg: data.message
		            });
		          }
		        },
		        error: function(XMLHttpRequest, textStatus, errorThrown) {
		          $.messager.show({
		            title: '提示',
		            msg: '请求发生错误请联系开发者'
		          });
		        }
		      });
		    }
		  });
		}
	
	
	
	function edit(username,id){
		 $('#formpassword').form('reset');
		if(username=='admin'){
			 $('#dialogPassword').dialog({
				    title: '修改密码',
				    width: 400,
				    height:260,
				    closed: false,
				    modal: true,
				    buttons: [{
				      text: '确定修改',
				      handler:  function(){
				    	  $('#dialogPassword').dialog('close');
				    	if($('#formpassword').form('validate')){
				        var win = $.messager.progress({
				          title: '温馨提示',
				          msg: '数据处理中，请稍候...',
				          text: 'loading'
				        }); //显示等待提示
				        $.ajax({
				        	url:'/yxt-admin/admin/adminUser/' + id + '/update',
				        	type:'put',
				        	data:$('#formpassword').serialize(),
				            success: function(data) {
				            	 $.messager.progress('close'); //等待提示关闭
				                if (data.stateCode == 200) {
				                  $('#formpassword').form('reset');
				                  $.messager.show({
				                    title: '提示消息',
				                    msg: data.message,
				                    timeout: 5000,
				                    showType: 'slide'
				                  });
				                  setTimeout(function() {
				                	  top.location.href = "/yxt-admin/adminLogin.html";
				                    },
				                    1000);
				                } else {
				                  $.messager.show({
				                    title: '提示',
				                    msg: data.message
				                  });
				                }
				              },
				              error: function(XMLHttpRequest, textStatus, errorThrown) {
				            	$.messager.progress('close'); //等待提示关闭
				                $.messager.show({
				                  title: '提示',
				                  msg: '请求发生错误请联系开发者'
				                });
				              }
				        });
				      }
				      }			   
				    },
				    {
				      text: '取消关闭',
				      handler: function() {
				        $('#dialogPassword').dialog('close');
				      }
				    }]
				  });
		}else{
			 $('#dialogPassword').dialog({
				    title: '修改密码',
				    width: 400,
				    height: 220,
				    closed: false,
				    modal: true,
				    buttons: [{
				      text: '确定修改',
				      handler:  function(){
				    	 
				    	if($('#formpassword').form('validate')){
				        var win = $.messager.progress({
				          title: '温馨提示',
				          msg: '数据处理中，请稍候...',
				          text: 'loading'
				        }); //显示等待提示
				        $.ajax({
				        	url:'/yxt-admin/admin/adminUser/' + id + '/update',
				        	type:'put',
				        	data:$('#formpassword').serialize(),
				            success: function(data) {
				            	 $.messager.progress('close'); //等待提示关闭
				                if (data.stateCode == 200) {
				                  $('#formpassword').form('reset');
				                  $('#dialogPassword').dialog('close');
				                } else {
				                  $.messager.show({
				                    title: '提示',
				                    msg: data.message
				                  });
				                }
				              },
				              error: function(XMLHttpRequest, textStatus, errorThrown) {
				            	$.messager.progress('close'); //等待提示关闭
				                $.messager.show({
				                  title: '提示',
				                  msg: '请求发生错误请联系开发者'
				                });
				              }
				        });
				      }
				      }			   
				    },
				    {
				      text: '取消关闭',
				      handler: function() {
				        $('#dialogPassword').dialog('close');
				      }
				    }]
				  });
		}
	}
	
	// 地址联动
	  var AddressBox = function () {
		   var self = this;
		   this.selectboxs = ["codeName", "code_nameShi", "code_nameQu", "code_namebut", "code_nameSheQu"];
		   var len = this.selectboxs.length, i, obj;
		   for (i = 0; i < len; ++i) {					  
		        obj = $("#" + this.selectboxs[i]);				       
		        if(i<len){
			        obj.combobox({
			        	valueField:'code_value',   
			            textField:'name',
			            onChange: (function (index) {
			                return function (newValue, oldValue) {
			                	if(newValue && newValue.length > 0){
				                    self.Clear(index + 1);
				                    self.Load(index + 1, newValue);
			                    }
			                	
			                };
			            })(i)
			        });				        	
		        }
		        
		    }
		};
		
		AddressBox.prototype = {
		    Clear: function (index) {
		        var i, ob;
		        index = index || 0;
		        for (i = index; i < this.selectboxs.length; ++i) {
		            ob = $("#" + this.selectboxs[i]);
              ob.combobox("clear");	
              ob.combobox("loadData", []);
		        }
		    },
		    Load: function (index, pid, initvalue, fun) {//加载数据 (索引 pid 初始化 回调函数)
		    	index = index || 0 ;
		    	pid = pid || "156";
		        if (pid) {
			        var self = this;
		            $.ajax({
		                url: '/yxt-admin/admin/address/' + pid + '/name',
		                success: function (back) {
		                	if(back.data) {
			                	var rows = back.data.rows, ob = $("#" + self.selectboxs[index]);					          
		                        ob.combobox("loadData", rows);
			                	if(initvalue !== undefined && initvalue !== null){
			                		ob.combobox("setValue", parseInt(initvalue));
			                	}
			                	if(fun){
			                		fun(ob.combobox("getValue"));
			                	}
	                        }
		                    self = null;
		                    pid = null;
		                    v = null;
		                }
		            });
		        }
		    },
		    ReSet:function(){// 返回的结果
				 this.Clear();
				 // obj = [];
				 if(window.parent && window.parent.__hospital_adressdata){
					 var adressdata = window.parent.__hospital_adressdata,len = this.selectboxs.length, i;
					 for (i = 0; i < len; ++i) {
						this.Load(i, adressdata[i-1], adressdata[i]);                        
					 }
				 }else{
				     this.Load();
				 }
		    },
		    GetVal:function(){// 获取combobox里的值   （实际上是code_value）
				   var len = this.selectboxs.length, i, val, selectlv = 0, code = "", selectlv = 1, code = 0;
				   for (i = len - 1; i >= selectlv; --i) {					  
					   val = $('#' + this.selectboxs[i]).combobox('getValue');
					   if(val.length>0){
						   code = val;
						   break;
					   }		        
				    }
				  return code;
		    },
		    SetAddress:function(code){// 修改地址的时候  先加载 set值		    	
		    	var codes = code.split(";"), len = codes.length, i=0 , pid = null;
		    	for(; i<len; ++i){
		    		this.Load(i, pid, codes[i]);
		    		pid = codes[i];
		    	}
		    	this.Load(i, pid);
		    	return this;
		    }
		};

		var addressbox = new AddressBox();
		
	function addHospoital(){
		  addressbox.ReSet();
		$('#hospout').show();
		$('#hospdialog').show();
		 $('#hosp_table').datagrid({
			    method: 'get',
			    url: '/yxt-admin/admin/hospitals?type=2',
			    toolbar: '#look',
			    rownumbers: true,
			    
			    singleSelect: true,
		 	    fitColumns: true,
			    frozenColumns:[[
				                {field:'id',checkbox:true}
				    		]],
			  loadFilter: function(data) {
			    	if(data.stateCode=='205'){
			    		top.location.href="/yxt-admin/admin/adminLogin.html";
			    		return;
			    	}else if(data.stateCode=='203'){
			    		return {total:0,rows:[]};
			    	}
			      return data.data;
			    }, 
			    onClickRow:function(index, row){
			        hospnewId=row.id;
			        hosName=row.name;
			    
			      
			    }
		  }); 
		$('#hospdialog').dialog({
			title:'卫生服务中心',
			toolbar: '#look',
			 width:860,
			 height:380, 
			 closed: false,
			 modal: true,			 
			 buttons: [{
			      text: '确定添加',
			      handler:function(){
			       if(hospnewId !=null && hospnewId!=''){
			    	   $('#hospital_id').textbox('setValue',hospnewId);
			          $('#hospital_id').textbox('setText',hosName);
			          $('#hospdialog').dialog('close');
			       }else{
			    	   $.messager.alert('提示','请选择卫生服务中心！','info');
			       }
			      }			 
			 },{
				 text:'取消关闭',
				 handler: function() {
					 hospnewId='';
					 $('#hospital_id').textbox('setText','');
				   $('#hospdialog').dialog('close');
				      }
			 }],
		});
	}
	
	function queryhos(){		
		$('#hosp_table').datagrid('load', {
			 name: $('#lookhosName').textbox('getValue')==null ? null : $('#lookhosName').textbox('getValue'),
			 addressCode: addressbox.GetVal()==0 ? null : addressbox.GetVal()
		})
		$('#hosp_table').datagrid('reload');		
		}
	
	
	 
</script> 
 </head> 
 <body class="easyui-layout" id="layout">
 <div id="west" data-options="region:'west',collapsible:false,split:false">
<!--   搜索栏 --> 
  <div id="seach"> 
   <label>用户姓名:</label> 
   <input id="name" class="easyui-textbox" style="width: 120px;" /> 
   <label>用户类型</label> 
  <select class="easyui-combobox" id="usertype" style="width:120px;" data-options="editable:false,panelHeight:'auto'">
            <option></option>   
		    <option value="1">管理员</option>   
		    <option value="2">协同人员</option> 
		    <option value="3">机构人员</option>   
		</select> 
  
    
    
   <a href="javascript:query()" class="easyui-linkbutton"><i class="fa fa-search"></i> 搜索</a> 
   <a href="javascript:clear()" class="easyui-linkbutton"><i class="fa fa-ban"></i> 清除搜索条件</a> 
   <a href="javascript:add()" class="easyui-linkbutton"><i class="fa fa-plus"></i> 新增</a>
    <a href="javascript:re()" class="easyui-linkbutton"><i class="fa  fa-refresh"></i> 刷新当前页面</a>  
  </div> 
<!--   内容表格  -->
  <table id="main_table"> 
   <thead> 
    <tr> 
          <th data-options="field:'id',width:30">id</th> 
	     <th data-options="field:'username',width:30">用户姓名</th> 
	     <th data-options="field:'state',width:25,formatter:_sexformatter">状态</th> 
	     <th data-options="field:'user_type',width:25 ,formatter:_usertypeformatter">用户类型</th> 
	     <th data-options="field:'remark',width:25">备注</th> 
	     <th data-options="field:'img',align:'center',width:30,formatter:_opformatter">操作</th> 
	</tr> 
   </thead> 
  </table> 
 

<!--   添加  -->
  <div id="dialog"> 
   <form id="form" method="post"> 
    <table class="table-edit" width="100%" align="center"> 
     <tbody> 
      <tr> 
       <td style="width: 110px;">用户姓名</td> 
       <td><input class="easyui-textbox" name="username" id="username" style="width: 200px" data-options="required:true,validType:'length[0,32]',missingMessage:'用户姓名不能为空'"/>
       </td> 
       </tr>
       <tr class="pwd" >
       <td style="width: 100px;">用户密码</td> 
       <td><input class="easyui-textbox" type="password"  name="password" id="password" style="width: 200px" data-options="validType:'length[0,64]'"/>
       </td> 
      </tr> 
      
     <tr> 
       <td style="width: 100px;">状态</td> 
       <td>
       <select class="easyui-combobox" name="state" id="state" style="width:200px;" data-options="required:true,editable:false,panelHeight:'auto'">   
		    <option value="1">启用</option>   
		    <option value="0">停用</option>   
		</select> 
       </td> 
      </tr> 
      <tr> 
       <td style="width: 100px;">用户类型</td> 
       <td>
       <select class="easyui-combobox" name="user_type" id="user_type" style="width:200px;" data-options="required:true,editable:false,panelHeight:'auto'">   
		    <option value="1">管理员</option>   
		    <option value="2">协同人员</option>
		    <option value="3">机构人员</option>      
		</select> 
       </td> 
      </tr>
      <tr class="hospital">
       <td style="width: 100px;">卫生服务中心</td> 
        <td>
           <input class="easyui-textbox" name="hospital_id" id="hospital_id" style="width:200px;"/>&nbsp;&nbsp;&nbsp;<a class="easyui-linkbutton" onclick="addHospoital()">选择机构</a>
        </td>
      </tr>
       <tr>
       <td style="width: 100px;">备注</td> 
       <td><input class="easyui-textbox" type="text"  name="remark" id="remark" style="width: 200px" data-options="validType:'length[0,64]'"/>
       </td> 
      </tr> 
     </tbody> 
    </table> 
   </form> 
  </div>
  </div>
  
 <!--  修改密码  -->
 <div id="dialogPassword"> 
   <form id="formpassword" method="post"> 
    <table class="table-edit" width="100%" align="center"> 
     <tbody> 
      <tr> 
       <td style="width: 110px;">新密码</td> 
       <td><input class="easyui-textbox" type="password" name="password" id="pwd" style="width: 200px" data-options="required:true,validType:['length[6,32]']" missingmessage="新密码不能为空！" />
       </td> 
       </tr>
       <tr>
       <td style="width: 100px;">确认密码</td> 
       <td><input class="easyui-textbox" type="password"  name="olderpassword" id="olderpassword" style="width: 200px"  data-options="required:true,validType:['length[6,32]','pwdMatch']" missingmessage="确认新密码不能为空！"/>
       </td> 
      </tr>
     </tbody> 
    </table> 
   </form> 
  </div> 
  
  
<!--  选择卫生服务中心  -->
<div id="hospout">
 <div id="look">
 <label>    省:</label>     <input class="easyui-combobox" name="codeName" id="codeName" style="width:120px;" data-options="editable:false"/> 
 <label>	市  :</label>   <input class="easyui-combobox" name="code_nameShi" id="code_nameShi" style="width:120px;" data-options="editable:false"/>
 <label>	区/县:</label>  <input class="easyui-combobox" name="code_nameQu" id="code_nameQu" style="width:120px;" data-options="editable:false"/> 
 <label>	街道: </label>  <input class="easyui-combobox" name="code_namebut" id="code_namebut" style="width:150px;" data-options="editable:false"/>	
 <label>	 社区:</label>   <input class="easyui-combobox" name="code_nameSheQu" id="code_nameSheQu" style="width:150px" data-options="editable:false"/><br>
  <label>	 医疗机构名称:</label> <input  class="easyui-textbox" style="width: 200px;" name="lookhosName" id="lookhosName"/>
   <input name="addressId" id="addressId" style="display:none" >
     <a href="javascript:queryhos()" class="easyui-linkbutton"><i class="fa fa-search"></i> 搜索</a>
     <a href="javascript:clear()" class="easyui-linkbutton"><i class="fa fa-search"></i>清除搜索条件</a>  
 </div>
 <div id="hospdialog"  > 
   <form id="hospform" method="post">  
     <table id="hosp_table" >   
       <thead> 
        <tr>     
       <th data-options="field:'name',width:100">医疗机构(单选)</th> 
       </tr>
       </thead>
       <tbody>   
    	</tbody>   
     </table>
   
	            
   </form> 
  </div>
</div> 
  
  
 </body>
</html> 