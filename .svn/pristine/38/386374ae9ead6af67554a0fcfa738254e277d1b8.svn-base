package org.system.controller.impl;


import java.io.File;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import javax.servlet.http.HttpServletRequest;

import org.core.result.ResultCode;
import org.core.result.ResultMap;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.web.multipart.MultipartFile;
import org.system.controller.iface.IFileController;
import org.system.message.Message;

@Controller
public class FileController implements IFileController {
	
    private static  String picture;
	Logger log = LoggerFactory.getLogger(FileController.class);

	@Override
	public Map<String, Object> uploadFile(MultipartFile[] files, HttpServletRequest request) {

	
		String path = request.getSession().getServletContext().getRealPath("/images");
	
		List<Map<String, Object>> fileList = new ArrayList<>();
		// 判断file数组不能为空并且长度大于0
		if (files != null && files.length > 0) {
			// 循环获取file数组中得文件
			for (int i = 0; i < files.length; i++) {
				MultipartFile file = files[i];
				// 保存文件
				Map<String, Object> temp = new HashMap<>();
				temp.put("path", saveFile(file, path));
				fileList.add(temp);
			}
		}
		return ResultMap.convertMap(ResultCode.CODE_SUCCESS, fileList, Message.bundle("insert.success"));
		
	}

	
	private  String saveFile(MultipartFile file, String path) {
		
		if (!file.isEmpty()) {
			try {
				String fileName=UUID.randomUUID()+file.getOriginalFilename().substring(file.getOriginalFilename().lastIndexOf("."));
				// 转存文件
				File temp=new File(path, fileName);
				if(!temp.exists()){
					temp.mkdirs();
				}
				file.transferTo(temp);
				FileController.picture="http://localhost:8080/yxt-admin/images/" + fileName;
				System.out.println("====="+FileController.getPicture());
				return FileController.getPicture(); 
				
			} catch (Exception e) {
				e.printStackTrace();
			}
		}
		return FileController.getPicture();
	}


	public static String getPicture() {
		return picture;
	}


	public static void setPicture(String picture) {
		FileController.picture = picture;
	}
	
	
	
}
