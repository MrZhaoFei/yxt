<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.system.mapper.service.UserServiceMapper" >
	
	<!-- 新增 -->
	<insert id="insert" parameterType="org.system.entity.service.UserService" >
		insert into user_service(user_service_pack_id,product_service_id,times,lock_times,user_id)
			values(#{userServicePackId},#{productServiceId},#{times},#{lockTimes},#{userId})
	</insert>
	<!-- 修改 -->
	<update id="update" parameterType="org.system.entity.service.UserService">
		update user_service set id=#{id}
		<if test="times!=null">
			,times=#{times}
		</if>
		<if test="lockTimes !=null">
			,lock_times=#{lockTimes} 
		</if>
			where id=#{id}
	</update>
	<!-- 进行归零操作 -->
	<update id="updateUserServiceZero" parameterType="org.system.entity.service.UserService">
		update user_service set 
		<if test="times !=null">
			times=#{times}
		</if>
		<where>
			<if test="userId !=null ">
				user_id=#{userId}
			</if>
			<if test="userServicePackId !=null ">
				and user_service_pack_id=#{userServicePackId}
			</if>
			<if test="productServiceId !=null ">
				and product_service_id=#{productServiceId}
			</if>
		</where>
	</update>
	<!-- 根据userId和userServicePackId和product_service_id判断用户是否包含该服务  -->
	<select id="checkExists" parameterType="org.system.entity.service.UserService" resultType="map">
		select us.id,us.times,us.lock_times lockTimes from user_service us 
		<where>
			<if test="userId !=null ">
				user_id=#{userId}
			</if>
			<if test="userServicePackId !=null">
				and user_service_pack_id=#{userServicePackId}
			</if>
			<if test="productServiceId !=null">
				and product_service_id=#{productServiceId}
			</if>
		</where>
		
	</select>	
	<!-- 查询列表 -->
	<select id="queryAll" parameterType="org.system.entity.service.UserService" resultType="map">
		select us.id,us.times,us.lock_times lockTimes,ps.name serviceName,usp.create_time createTime,usp.expire_time expireTime,ps.common_field commonField,ps.service_type_id serviceTypeId,st.`name` serviceTypeName,
		a.name addressName, ps.doctor_level_id doctorLevelId,dl.doctor_level_name doctorLevelName,ps.doctor_type_id doctorTypeId,dt.name doctorTypeName,ps.id productServiceId
		from user_service us
		left join product_service ps on ps.id=us.product_service_id
		left join service_type st on st.id=ps.service_type_id
		left join user_service_pack usp on usp.id=us.user_service_pack_id
		left join service_pack_condition spc on spc.id=usp.service_pack_id
		left join address a on a.id=spc.address_id
		left join doctor_level dl on dl.id=ps.doctor_level_id
		left join doctor_type dt on dt.id=ps.doctor_type_id
		where usp.expire_time&gt;now()
		<if test="taskId !=null">
			and usp.expire_time &gt;(select srt.applied_date appliedDate from service_resp_task srt where srt.id=#{taskId}) 
		</if>  
		<if test="userId !=null">
			and us.user_id=#{userId}
		</if>
		<if test="productServiceId !=null">
			and us.product_service_id=#{productServiceId}
		</if>
		<if test="serviceType !=null">
			<if test="serviceType.id !=null">
				and ps.service_type_id=#{serviceType.id}
			</if>
		</if>
		<if test="servicePack !=null">
			<if test="servicePack.id !=null">
				and usp.service_pack_id=#{servicePack.id}
			</if>
		</if>
	</select>
	<!-- 用户查询用户服务剩余次数 -->
	<select id="getUserServicesByUserList" parameterType="org.system.entity.service.UserService" resultType="map">
		SELECT us.id,us.def_times defTimes,us.times,us.lock_times lockTimes,
			us.user_id userId,u.phone,ud.`name` userName,ps.`name` productServiceName,st.`name` serviceTypeName 
		FROM user_service us
		LEFT JOIN user_service_pack usp on usp.id=us.user_service_pack_id
		LEFT JOIN product_service ps on ps.id=us.product_service_id
		LEFT JOIN service_type st on st.id=ps.service_type_id
		LEFT JOIN `user` u on u.id=us.user_id
		LEFT JOIN user_detail ud on ud.user_id=u.id
		WHERE us.user_id=#{userId}
		<if test="userServicePackId !=null">
			and usp.id=#{userServicePackId}
		</if>
		<if test="servicePack !=null">
			<if test="servicePack.id !=null">
				and usp.service_pack_id=#{servicePack.id}
			</if>
		</if>
	</select>	
	
	<!-- 根据主键查询单个 -->
	<select id="queryOne" parameterType="org.system.entity.service.UserService" resultType="map">
	select us.id,us.times,us.lock_times lockTimes,ps.name serviceName,usp.create_time createTime,usp.expire_time expireTime,
		a.name addressName, ps.common_field commonField,ps.id productServiceId,ps.service_type_id serviceTypeId 
		from user_service us 
		left join product_service ps on ps.id=us.product_service_id 
		left join user_service_pack usp on usp.id=us.user_service_pack_id
		left join service_pack_condition spc on spc.id=usp.service_pack_id
		left join address a on a.id=spc.address_id
	where us.id=#{id}
	</select>
	<!--用户最近使用服务信息  -->
	<select id="getUserServicesByUserUsedList" parameterType="org.system.entity.service.UserService" resultType="map">
	select  user_id userId,user_name userName,product_service_name productServiceName,user_service_id userServiceId,
			service_resp_task_id serviceRespTaskId,create_time createTime
		from v_get_user_service_used_records  
	where user_id=#{userId}
	</select>
	
</mapper>