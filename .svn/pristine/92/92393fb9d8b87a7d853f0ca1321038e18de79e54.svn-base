<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.system.mapper.service.resp.FormNotExistDetailyMapper" >

	<!-- 删除 -->
  <delete id="delete" parameterType="java.lang.Integer" >
    delete from form_not_exist_detaily
    where id = #{id}
  </delete>
  <!-- 新增 -->
  <insert id="insert" parameterType="org.system.entity.service.resp.FormNotExistDetaily"  useGeneratedKeys="true"  keyProperty="id">
    insert into form_not_exist_detaily (service_resp_task_id, user_service_id, 
      create_time, form_desc, from_doctor_id, 
      state, source_tag, form_number
      )
    values (#{serviceRespTaskId,jdbcType=INTEGER}, #{userServiceId,jdbcType=INTEGER}, 
      #{createTime,jdbcType=TIMESTAMP}, #{formDesc,jdbcType=VARCHAR}, #{fromDoctorId,jdbcType=INTEGER}, 
      #{state,jdbcType=INTEGER}, #{sourceTag,jdbcType=INTEGER}, #{formNumber,jdbcType=VARCHAR}
      )
  </insert>
  <!-- 修改 -->
  <update id="update" parameterType="org.system.entity.service.resp.FormNotExistDetaily" >
    update form_not_exist_detaily  set id=#{id}
    <if test="serviceRespTaskId !=null ">
     	,service_resp_task_id = #{serviceRespTaskId}
    </if>
    <if test="userServiceId !=null ">
     	,user_service_id = #{userServiceId}
    </if>
    <if test="createTime !=null ">
     	,create_time = #{createTime}
    </if>
    <if test="formDesc !=null and formDesc !=''">
     	,form_desc = #{formDesc}
    </if>
    <if test="fromDoctorId !=null ">
     	,from_doctor_id = #{fromDoctorId}
    </if>
    <if test="state !=null ">
     	,state = #{state}
    </if>
    <if test="sourceTag !=null ">
     	,source_tag = #{sourceTag}
    </if>
    where id = #{id}
  </update>
  <!-- 查询单个 -->
  <select id="queryOne"  resultType="map" parameterType="org.system.entity.service.resp.FormNotExistDetaily" >
              select fned.id, fned.service_resp_task_id serviceRespTaskId, fned.user_service_id userServiceId, fned.create_time createTime,
     fned.form_desc formDesc, fned.from_doctor_id fromDoctorId,ps.`name` serviceName,
    fned.state, fned.source_tag sourceTag, fned.form_number formNumber,us.times times,us.lock_times lockTimes,srt.task_number taskNumber,
		srt.task_type_id taskTypeId,tt.task_name taskName,srt.task_status taskStatus ,dd.`name` doctorName ,ud.`name` userName,u.phone,
		srt.user_id userId,srt.estimation_msg_content estimationMsgContent,srt.estimation_star_level estimationStarLevel,srt.last_remind_time lastRemindTime,
		srt.accept_date acceptDate,srt.doctor_remind doctorRemind 
    from form_not_exist_detaily fned
	LEFT JOIN user_service us on us.id=fned.user_service_id
	left join product_service ps on ps.id=us.product_service_id
	LEFT JOIN service_resp_task srt on srt.id=fned.service_resp_task_id
	LEFT JOIN `user` u on u.id=srt.user_id 
	LEFT JOIN user_detail ud on ud.user_id=u.id 
	LEFT JOIN doctor_detail dd on dd.doctor_id=srt.doctor_id
    LEFT JOIN task_type tt on tt.id=srt.task_type_id
    where fned.id = #{id}
  </select>
  <!-- 查询 是否有无服务响应的任务未完成 -->
  <select id="getUnfinishedFormNotExistDetailyList"  resultType="map" parameterType="org.system.entity.service.resp.ServiceRespTask" >
     select fned.id, fned.service_resp_task_id serviceRespTaskId, fned.user_service_id userServiceId, fned.create_time createTime,
     fned.form_desc formDesc, fned.from_doctor_id fromDoctorId, 
    fned.state, fned.source_tag sourceTag, fned.form_number formNumber,us.times times,us.lock_times lockTimes
    from form_not_exist_detaily fned
	LEFT JOIN user_service us on us.id=fned.user_service_id 
    where fned.service_resp_task_id=#{id} and  fned.state =1
  </select>
  <!-- 查询所有 -->
  <select id="queryAll" resultType="map"  parameterType="org.system.entity.service.resp.FormNotExistDetaily">
     select fned.id, fned.service_resp_task_id serviceRespTaskId, fned.user_service_id userServiceId, fned.create_time createTime,
     fned.form_desc formDesc, fned.from_doctor_id fromDoctorId,ps.`name` serviceName, 
    fned.state, fned.source_tag sourceTag, fned.form_number formNumber,us.times times,us.lock_times lockTimes,srt.task_number taskNumber,
		srt.task_type_id taskTypeId,tt.task_name taskName,srt.task_status taskStatus,srt.promoter_doctor_id promoterDoctorId,dd.`name` promoterDoctorName ,
		srt.promoter_user_id promoterUserId,ud.`name` promoterUserName,u.phone,
		srt.user_id userId,srt.estimation_msg_content estimationMsgContent,srt.estimation_star_level estimationStarLevel,srt.last_remind_time lastRemindTime,
		srt.accept_date acceptDate,srt.doctor_remind doctorRemind 
    from form_not_exist_detaily fned
	LEFT JOIN user_service us on us.id=fned.user_service_id
	left join product_service ps on ps.id=us.product_service_id
	LEFT JOIN service_resp_task srt on srt.id=fned.service_resp_task_id
	LEFT JOIN `user` u on u.id=srt.promoter_user_id 
	LEFT JOIN user_detail ud on ud.user_id=u.id 
	LEFT JOIN doctor d on d.id=srt.promoter_doctor_id
	LEFT JOIN doctor_detail dd on dd.doctor_id=d.id
	LEFT JOIN task_type tt on tt.id=srt.task_type_id
    <where>
    	<if test="fromDoctorId !=null">
    		fned.from_doctor_id=#{fromDoctorId}
    	</if>
    	<if test="serviceRespTaskId !=null">
    		and fned.service_resp_task_id=#{serviceRespTaskId}
    	</if>
    	<if test="userServiceId !=null">
    		and fned.user_service_id=#{userServiceId}
    	</if>
    </where>
  </select>
</mapper>