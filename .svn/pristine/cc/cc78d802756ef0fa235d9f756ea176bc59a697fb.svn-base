<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head> 
  <base href="/yxt-admin/" /> 
  <title>基础产品列表</title> 
   <meta http-equiv="Access-Control-Allow-Origin" content="*">
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
   <meta HTTP-EQUIV="Pragma" CONTENT="no-cache"> 
   <meta HTTP-EQUIV="Cache-Control" CONTENT="no-cache"> 
   <meta HTTP-EQUIV="Expires" CONTENT="0"> 
  <link rel="stylesheet" type="text/css" href="js/easyui/themes/icon.css" /> 
  <link rel="stylesheet" type="text/css" href="js/easyui/themes/gray/easyui.css" /> 
  <link rel="stylesheet" type="text/css" href="js/trumbowyg/design/css/trumbowyg.css" /> 
  <link rel="stylesheet" type="text/css" href="css/jquery.flex-images.css" /> 
  <link rel="stylesheet" type="text/css" href="css/icon/font-awesome.min.css" /> 
  <link rel="stylesheet" type="text/css" href="css/upload/webuploader.css" /> 
  <link rel="stylesheet" type="text/css" href="css/upload/style.css" /> 
  <link rel="stylesheet" type="text/css" href="css/web.css" /> 
  <link rel="stylesheet" href="/yxt-admin/webuploader/styles/default.css?ver=v1.001">
  <link rel="stylesheet" href="/yxt-admin/webuploader/styles/webuploader.css?ver=v1.001">
  <script type="text/javascript" src="/yxt-admin/webuploader/scripts/jquery-1.12.1.min.js?ver=v1.001"></script>
  <script type="text/javascript" src="/yxt-admin/webuploader/scripts/webuploader.js?ver=v1.001"></script>
  <script type="text/javascript" src="/yxt-admin/webuploader/scripts/uploader.js?ver=v1.001"></script>
  <script type="text/javascript" src="js/jquery.min.js"></script> 
  <script type="text/javascript" src="js/easyui/jquery.easyui.min.js"></script> 
  <script type="text/javascript" src="js/easyui/locale/easyui-lang-zh_CN.js"></script> 
  <script type="text/javascript" src="js/easyui/extend.easyui.js"></script> 
  <script type="text/javascript" src="js/jquery.flex-images.min.js"></script> 
   <script type="text/javascript" src="js/util.js"></script> 
  <script type="text/javascript">
  var heightnum="";
  $(function() {
	  $('#packageTypeName').combobox('reload');
	  heightnum=document.body.clientHeight;
	  /*初始化控件*/
	  $('#main_table').datagrid({
	    method: 'get',
	    url: '/yxt-admin/admin/servicePack?ran=' + Math.random(),
	    toolbar: '#seach',
	    pagination: true,
	    fit: true,
	    pageSize:20,
	    fitColumns: true,
	    border: false,
	    rownumbers: true,
	    singleSelect: true,
	    loadFilter: function(data) {
	    	if(data.stateCode=='205'){
	    		top.location.href="/yxt-admin/admin/adminLogin.html";
	    		return;
	    	}else if(data.stateCode=='203'){
	    		return {total:0,rows:[]};
	    	}
	    	var rows = data.data.rows,rowslen = rows.length,i;
	    	for(i = 0 ; i < rowslen; ++i){
		    	rows[i].createDate = DateToString(rows[i].createDate);
	    	}
	      return data.data;
	    }
	  });
	});
  
  
  function _stateformatter(value, row, index) {
	  if (value == 1) {
	    return "上架";
	  }if (value == 2){
	  return "下架";
		  
	  }
	}
  function _priceformatter(value, row, index) {
	  if (value == null || value==0) {
	    return "￥ 0.00";
	  }if(value!=null){
		  var f = value.toFixed(2);	
		  return  "￥"+f;
	  }
	}
  
  
	function query() {
	  $('#main_table').datagrid('load', {
	    name: $('#servicePack').textbox('getValue')
	  });
	}
	 function clear() {
	  $('#servicePack').textbox('clear');
	} 
	 function re(){
	   	  history.go(0) 
	     }
	function _opformatter(value, row, index) {
	  var a = '&nbsp;<a href="javascript:edit(\'' + index + '\',' + row.id + ')" title="编辑和详情"><i class="fa fa-pencil"></i></a>';	
	 var c = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp<a href="javascript:del(\'' + row.id + '\')" title="删除"><i class="fa fa-trash"></i></a>';
	  return a+c;
	}
	

	function add() {
		$('.time').hide();
		
		  $('#acquisitive').numberbox('readonly',false)
		  $('#packageTypeName').combobox('readonly',false);
		  $('#spName').textbox('readonly',false);
		// 添加的时候对图片设置为空的
		$('#pkgPicUrl').html("");
		$('#pkgPicDetailUrl').html("");
		var imgup1 = new NebFiles.ImageUp({
            show: true ,
            maxnum: 1
        });
	    // 将上传框放某标签里面
        imgup1.AddTo($('#pkgPicUrl'));
	  		// 上传图片产品包
	  		var imgup2 = new NebFiles.ImageUp({
            show: true ,
            maxnum: 1
        });
	    // 将上传框放某标签里面
        imgup2.AddTo($('#pkgPicDetailUrl'));

	     // 选择基公为服务包 有效时间不设置
	     $('#packageTypeName').combobox({
	    	 onChange:function(newValue,oldValue){
	    		 if(newValue==1){
	    			 $('#acquisitive').textbox({disable:true}); 
	    		 }else{
	    			 $('#acquisitive').textbox({disable:false});
	    		    	$('#acquisitive').textbox({
	    		    		required:true
	    		    	}) 
	    		 }
	    	 }
	     }); 
	  $('#form').form('reset');
	  $('#dialog').dialog({
		    title: '添加信息',
		    width:900,
		    height: heightnum>650 ? 650 :heightnum-100,
		    closed: false,
		    modal: true,
		    buttons: [{
		      text: '确定添加',
		      handler: function() {
		     	  var v = $('#form').form('validate');   
		    	  if(v){
		    		     $.ajax({
				              type: 'post',
				              url: '/yxt-admin/admin/servicePack/insert',
				              data:{
				            	  name:$('#spName').textbox('getValue'),
			                	  price:0,
			                	  desc:$('#de').textbox('getValue'),
			                	  acquisitive:$('#acquisitive').numberbox('getValue'),
			                      state:$('#state').combobox('getValue'),
			                      packageTypeId:$('#packageTypeName').combobox('getValue'),	
			                      pkgPicUrl:imgup1.GetImages().toString(),
			                      pkgPicDetailUrl:imgup2.GetImages().toString()
			                	 
				              },
	                success: function(data) {
	                    if (data.stateCode == 200) {
	                      $('#dialog').dialog('close');
	                      $('#main_table').datagrid('reload');
	                      $.messager.show({
	                        title: '提示消息',
	                        msg: data.message,
	                        timeout: 5000,
	                        showType: 'slide'
	                      });		                     
	                      
	                    } else {
	                      $.messager.show({
	                        title: '提示',
	                        msg: data.message
	                      });
	                    }
	                  },
	                  error: function(XMLHttpRequest, textStatus, errorThrown) {
	                    $.messager.show({
	                      title: '提示',
	                      msg: '请求发生错误请联系开发者'
	                    });
	                  }
				              
				 });
		    	  }

		    	
		        }
		      },
		    
		    
		    {
		      text: '取消关闭',
		      handler: function() {
		        $('#dialog').dialog('close');
		      }
		    }]
		  
		  
		  });
	}
	
	// 修改
	function edit(index, id) {
		$('.time').show();
		$('#pkgPicUrl').html("");
		 $('#pkgPicDetailUrl').html("");
		  var imgup1 = new NebFiles.ImageUp({
	            show: true,
	            maxnum:1  
	        });
		    // 将上传框放某标签里面
	        imgup1.AddTo($('#pkgPicUrl'));
		    
	        var imgup2 = new NebFiles.ImageUp({
	            show: true ,
	            maxnum:1  
	        });
		    // 将上传框放某标签里面
	        imgup2.AddTo($('#pkgPicDetailUrl')); 
		  $('#form').form('reset');
	
				   $.get('/yxt-admin/admin/servicePack/' + id + '/detail',
				  function(data) {
					  data.data.createDate=DateToString(data.data.createDate);
				    $('#form').form('load', data.data);	 
				    // 显示图片
				       var pic=data.data.pkgPicUrl;
						  if(pic!=null && pic!=''){
					    imgup1.AddImages(data.data.pkgPicUrl.split(","));
				        imgup1.AddTo($('#pkgPicUrl'));
						  }
							var file=data.data.pkgPicDetailUrl;
							if(file!=null && file!=''){					        
								imgup2.AddImages(data.data.pkgPicDetailUrl.split(","))
					         imgup2.AddTo($('#pkgPicDetailUrl'));	
							}
				  });
				  $('#createDate').datetimebox('readonly');
				
				  $('#dialog').dialog({
				    title: '编辑/查看信息',
				    width:900,
				    height: heightnum>650 ? 650 :heightnum-100,
				    closed: false,
				    modal: true,
				    buttons: [{
				      text: '确定修改',
				      handler: function() {
				    	
				        var v = $('#form').form('validate');
				    	  var timee=$('#createDate').datetimebox('getValue');
					    	timee=timee.replace(/-/g,"/");
					    	var datee=new Date(timee);
				        if (v) {
				  	          $.ajax({
				  	            type: 'put',
				  	            url: '/yxt-admin/admin/servicePack/' + id + '/update',
				  	            data:{
				  	            	 name:$('#spName').val(),
				                	  price:0,
				                	  desc:$('#de').textbox('getValue'),
				                	  acquisitive:$('#acquisitive').numberbox('getValue'),
				                      state:$('#state').combobox('getValue'),
				                      packageTypeId:$('#packageTypeName').combobox('getValue'),	                		  
				                      createDate:datee,
				                      pkgPicUrl:imgup1.GetImages().length==0 ? null :imgup1.GetImages().toString(),
				                      pkgPicDetailUrl: imgup2.GetImages().length==0 ? null :imgup2.GetImages().toString()
				                  },
				  	            success: function(data) {
				  	              if (data.stateCode == 200) {
				  	                $('#dialog').dialog('close');
				  	                $('#form').form('reset');
				  	                $('#main_table').datagrid('reload');
				  	                $.messager.show({
				  	                  title: '提示消息',
				  	                  msg: data.message,
				  	                  timeout: 5000,
				  	                  showType: 'slide'
				  	                });
				  	              } else {
				  	                $.messager.show({
				  	                  title: '提示',
				  	                  msg: data.message
				  	                });
				  	              }
				  	            },
				  	            error: function(XMLHttpRequest, textStatus, errorThrown) {
				  	              $.messager.show({
				  	                title: '提示',
				  	                msg: '请求发生错误请联系开发者'
				  	              });
				  	            }
				  	          });

				        }

				      }
				    },
				    {
				      text: '取消关闭',
				      handler: function() {
				        $('#dialog').dialog('close');
				      }
				    }]
				  }); 	
				

	}
	

	function del(id) {	
	  $.messager.confirm('确认', '您确认想要删除记录吗？',
	  function(r) {
	    if (r) {
	      $.ajax({
	        type: 'delete',
	        url: '/yxt-admin/admin/servicePack/' + id + '/delete',
	        success: function(data) {
	          if (data.stateCode == 200) {
	            $('#main_table').datagrid('reload');
	            $.messager.show({
	              title: '提示消息',
	              msg: data.message,
	              timeout: 5000,
	              showType: 'slide'
	            });
	          } else {
	            $.messager.show({
	              title: '提示',
	              msg: data.message
	            });
	          }
	        },
	        error: function(XMLHttpRequest, textStatus, errorThrown) {
	          $.messager.show({
	            title: '提示',
	            msg: '请求发生错误请联系开发者'
	          });
	        }
	      });
	    }
	  });
	}

</script> 
 </head> 
 <body> 
  <!-- 全局日历控件 --> 
  <!--  <div id="sc" class="easyui-calendar" data-options="validator: function(date){return date<=new Date();}"></div> -->
  <!-- 搜索栏 --> 
  <div id="seach"> 
   <label>产品包名称</label> 
   <input id="servicePack" class="easyui-textbox" style="width: 120px;" /> 
   <a href="javascript:query()" class="easyui-linkbutton"><i class="fa fa-search"></i> 搜索</a> 
   <a href="javascript:clear()" class="easyui-linkbutton"><i class="fa fa-ban"></i> 清除搜索条件</a> 
   <a href="javascript:add()" class="easyui-linkbutton"><i class="fa fa-plus"></i> 新增</a>
    <a href="javascript:re()" class="easyui-linkbutton"><i class="fa  fa-refresh"></i> 刷新当前页面</a>  
  </div> 
  <!-- 内容表格 --> 
  <table id="main_table"> 
   <thead> 
    <tr> 
      <th data-options="field:'id',width:10">id</th>  
      <th data-options="field:'servicePackName',width:50">产品包名称</th> 
      <th data-options="field:'price',width:50,align:'right',precision:2,formatter:_priceformatter">产品包价格(元)</th> 
      <th data-options="field:'createDate',width:50">创建时间</th>
      <th data-options="field:'acquisitive',width:50,align:'right'">有效时间(月)</th>
      <th data-options="field:'packageTypeName',width:50">产品包类型</th>
      <th data-options="field:'state',width:50,formatter:_stateformatter">状态</th>
      <th data-options="field:'de',width:50">产品包描述</th> 
     <th data-options="field:'img',align:'center',width:30,formatter:_opformatter">操作</th> 
     
    </tr> 
   </thead> 
  </table> 
 
  
 
  
   <div id="dialog">  
   <form id="form" method="post"> 
    <table class="table-edit" width="100%" align="center"> 
     <tbody> 
      <tr> 
       <td style="width: 110px;">产品包名称</td> 
       <td><input class="easyui-textbox" name="servicePackName"  id="spName" style="width: 200px" data-options="required:true,validType:'length[0,128]',missingMessage:'产品包名称不能为空'"/>
       </td>
       <td style="width: 110px;">产品包描述</td> 
       <td><input class="easyui-textbox" name="de" id="de" style="width: 200px ;height:50px;" data-options="multiline:true,validType:'length[0,512]'"/>
       </td> 
       </tr>
      
      <tr> 
      <td style="width: 110px;">产品包类型</td> 
       <td><input class="easyui-combobox"  name="packageTypeName" id="packageTypeName" style="width:200px;"
        data-options=" url:'/yxt-admin/admin/packageType',
                editable:false,
                required:true,
			    method:'get',
			    valueField:'id',    
			    textField:'name',
			    loadFilter:function(data){
					 return data.data.rows;
					}"/>
       </td> 
      <td style="width: 110px;">状态</td> 
       <td> <select class="easyui-combobox" name="state" id="state" style="width:200px;" data-options="required:true,editable:false,panelHeight:'auto'">   
           <option value="1">上架</option>   
		    <option value="2">下架</option>
		    </select>   
       </td> 
       </tr> 
       <tr> 
		 <td style="width: 110px;">有效时间</td> 
       <td><input class="easyui-numberbox" name="acquisitive" id="acquisitive" style="width: 200px" data-options=" precision:0,min:0"/>个月
       </td>
      
        <td style="width: 110px;" class="time">创建时间</td> 
       <td class="time"><input class="easyui-datetimebox" name="createDate"  id="createDate"  style="width: 200px" />
       </td> 
     
       </tr> 
        <tr>
       <td colspan="3" align="left">产品包缩略图
        <div id="pkgPicUrl" > 
        </div> <span style="color:red"> (提示:推荐上传：60px*60px倍数的图片,支持图片格式 gif,jpg,jpeg,bmp,png)</span>
        </td> 
     </tr>

     <tr >
       <td colspan="3" align="left">产品包详细图   
        <div id="pkgPicDetailUrl" > 
        </div>   <span style="color:red"> (提示:推荐上传：640px*250px倍数的图片 ,支持图片格式 gif,jpg,jpeg,bmp,png)</span>
        </td> 
     </tr>
     </tbody> 
    </table> 
   </form>    
  </div> 
 </body>
</html>