package org.system.controller.impl.doctor;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.core.result.ResultCode;
import org.core.result.ResultMap;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.validation.BindingResult;
import org.system.Global;
import org.system.controller.iface.doctor.IDoctorController;
import org.system.entity.contract.Contract;
import org.system.entity.doctor.Doctor;
import org.system.entity.doctor.DoctorDetail;
import org.system.entity.doctor.DoctorDoctorGroup;
import org.system.entity.relation.HospiDepartDoctorRelation;
import org.system.message.Message;
import org.system.service.iface.HospiDepartDoctorRelation.IHospiDepartDoctorRelationService;
import org.system.service.iface.contract.IContractService;
import org.system.service.iface.doctor.IDoctorDetailService;
import org.system.service.iface.doctor.IDoctorDoctorGroupService;
import org.system.service.iface.doctor.IDoctorService;

@Controller
public class DoctorController implements IDoctorController {
    
	Logger log = LoggerFactory.getLogger(DoctorController.class);
	
	@Resource
	private IDoctorService doctorService;
	
	@Resource
	private IDoctorDoctorGroupService doctorDoctorGroupService;
	
	@Resource
	private IDoctorDetailService doctorDetailService;
	
	@Resource
	private IContractService contractService;
	
	@Resource
	private IHospiDepartDoctorRelationService  hospiDepartDoctorRelationService;
	
	
	
	@Override
	public Map<String, Object> insertDoctor(Doctor doctor, BindingResult result) {
				// 查询姓名是否已注册
				Doctor name = new Doctor();
				name.setName(doctor.getName());
				Map<String, Object> doctorMapForName = doctorService.getDoctorByFiled(name);
				if (doctorMapForName != null && doctorMapForName.size() > 0) {
					return ResultMap.convertMap(ResultCode.CODE_FAIL, Message.bundle("doctor.insert.name.exists"));	
				}

		       // 查询手机号是否已注册
		        Doctor phone = new Doctor();
		        phone.setPhone(doctor.getPhone());
				Map<String, Object> doctorMapForPhone = doctorService.getDoctorByFiled(phone);
				if (doctorMapForPhone != null && doctorMapForPhone.size() > 0) {
					return ResultMap.convertMap(ResultCode.CODE_FAIL, Message.bundle("doctor.insert.phone.exists"));	
				}
				
				
				
				 // 查询身份证号是否已注册
		        Doctor idCard = new Doctor();
		        idCard.setIdCard(doctor.getIdCard());
				Map<String, Object> doctorMapForidCard = doctorService.getDoctorByFiled(idCard);
				if (doctorMapForidCard != null && doctorMapForidCard.size() > 0) {
					return ResultMap.convertMap(ResultCode.CODE_FAIL, Message.bundle("doctor.insert.ID_Card.exists"));
				}
				
					
					// 检查数据是否存在
					Map<String, Object> dataMap = doctorService.getDoctorByFiled(doctor);
					if (dataMap != null && dataMap.size() > 0) {
						return ResultMap.convertMap(ResultCode.CODE_DATA_EXISTS, Message.bundle("data.exists"));
					}
					
					if (doctorService.insertDoctor(doctor)> 0) {
						// 新增成功
						return ResultMap.convertMap(ResultCode.CODE_SUCCESS, Message.bundle("insert.success"));
					}
					// 新增失败
					return ResultMap.convertMap(ResultCode.CODE_FAIL, Message.bundle("insert.fail"));
				
				
				
		   
	}

	@Override
	@Transactional
	public Map<String, Object> updateDoctor(Integer id, Doctor doctor, BindingResult result) {	
		 // 设置主键
	     doctor.setId(id);
	     HospiDepartDoctorRelation hospiDepartDoctorRelation=new HospiDepartDoctorRelation();
	     hospiDepartDoctorRelation.setDoctorId(id);
	     hospiDepartDoctorRelationService.deleteHospiDepartDoctorRelation(hospiDepartDoctorRelation);
			// 检查数据是否重复
			Map<String, Object> habitMap = doctorService.getDoctorByFiled(doctor);
			if (habitMap != null && habitMap.size() > 0) {
				// 数据已存在 返回提示结束流程
				//return ResultMap.convertMap(ResultCode.CODE_DATA_EXISTS, Message.bundle("data.exists"));
			}
			// 执行修改 判断状态
			if (doctorService.updateDoctor(doctor) > 0) {
				// 修改成功 返回提示结束流程
				return ResultMap.convertMap(ResultCode.CODE_SUCCESS, Message.bundle("update.success"));
			} else {
				// 修改失败 返回提示结束流程
				throw new RuntimeException();
				//return ResultMap.convertMap(ResultCode.CODE_FAIL, Message.bundle("update.fail"));
			}
	}

	@Override
	public Map<String, Object> getDoctorList(Doctor doctor, BindingResult result,HttpServletRequest req) {
		
         HttpSession session=req.getSession();
		 
		 if(session.getAttribute("user")!=null){
			 
			 Map<String, Object> resultMap = new HashMap<>();
			 //得到返回数据
			 List<Map<String, Object>> dataList = doctorService.getDoctorList(doctor);
			 if (dataList != null && dataList.size() > 0) {
				 //得到数据总数
				 resultMap.put(Global.DATA_TOTAL, doctor.getTotal());
				 resultMap.put(Global.DATA_ROWS, dataList);
				 return ResultMap.convertMap(ResultCode.CODE_SUCCESS, resultMap, Message.bundle("query.success"));
			 }
			 return ResultMap.convertMap(ResultCode.CODE_DATA_EMPTY, Message.bundle("query.empty"));
		 }else{
			 return ResultMap.convertMap(ResultCode.CODE_NO_LOGIN, Message.bundle("permission.no.login"));
		 }
	}

	@Override
	public Map<String, Object> getDoctorDetail(Integer id, Doctor doctor) {
		 // 设置实例的id属性
		doctor.setId(id);
		Map<String, Object> resultList = doctorService.getDoctorDetail(doctor);
		if (resultList != null && resultList.size() > 0) {
			return ResultMap.convertMap(ResultCode.CODE_SUCCESS, resultList, Message.bundle("query.success"));
		}
		return ResultMap.convertMap(ResultCode.CODE_DATA_EMPTY, Message.bundle("query.empty"));
	}

	@Override
	public Map<String, Object> deleteDoctor(Integer id, Doctor doctor) {
		
		Contract c=new Contract();
		c.setCreatorId(id);
		Map<String, Object>  contractList=contractService.getByFile(c);
		if(contractList != null && contractList.size()>0){		
			return ResultMap.convertMap(ResultCode.CODE_SUCCESS,Message.bundle("doctor.contract"));
		}
		 // 设置实例的id属性	
		doctor.setId(id);
		Map<String, Object> resultList =doctorService.getDoctorDetail(doctor); 
		if (resultList == null || resultList.size() <= 0) {
			return ResultMap.convertMap(ResultCode.CODE_DATA_EMPTY,Message.bundle("doctor.empty"));
		}
       // 删除团队里的医生
		 DoctorDoctorGroup ddg=new DoctorDoctorGroup();
	     ddg.setDoctorId(id);
	     int count=  doctorDoctorGroupService.deleteDoctorDoctorGroup(ddg);
	     
       // 删除医生详细信息 
	    DoctorDetail dd=new DoctorDetail();
	    dd.setDoctorId(id);
	    int num=doctorDetailService.deleteDoctorDetail(dd);
		//执行删除
		if ( doctorService.deleteDoctor(doctor)> 0) {
			return ResultMap.convertMap(ResultCode.CODE_SUCCESS,Message.bundle("delete.success"));
		}
		return ResultMap.convertMap(ResultCode.CODE_FAIL, Message.bundle("delete.fail"));
	}

	@Override
	public Map<String, Object> getDoctorDetailByDoctorId(Integer id, Doctor doctor) {
		doctor.setId(id);
		Map<String, Object> resultList = doctorService.getDoctorDetailByDoctorId(doctor);
		if (resultList != null && resultList.size() > 0) {
			return ResultMap.convertMap(ResultCode.CODE_SUCCESS, resultList, Message.bundle("query.success"));
		}
		return ResultMap.convertMap(ResultCode.CODE_DATA_EMPTY, Message.bundle("query.empty"));
	}

	@Override
	public Map<String, Object> getDoctorMaxId(Doctor doctor, BindingResult result) {
		Map<String, Object> resultMap = new HashMap<>();
		Map<String, Object> dataList =doctorService.getDoctorMaxId(doctor);
		if (dataList != null && dataList.size() > 0) {
			resultMap.put(Global.DATA_TOTAL, doctor.getTotal());
			resultMap.put(Global.DATA_ROWS, dataList);
			return ResultMap.convertMap(ResultCode.CODE_SUCCESS, resultMap, Message.bundle("query.success"));
		}
		return ResultMap.convertMap(ResultCode.CODE_DATA_EMPTY, Message.bundle("query.empty"));
	}

	
}
